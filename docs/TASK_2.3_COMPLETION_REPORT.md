# –û—Ç—á–µ—Ç –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏ 2.3: File Upload API

## ‚úÖ –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞

### –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

#### 1. FileProcessor Service (`backend/app/services/file_processor.py`)
**–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤** —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π 4 —Ñ–æ—Ä–º–∞—Ç–æ–≤:

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:**
- **TXT** - —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã —Å –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –∫–æ–¥–∏—Ä–æ–≤–∫–∏ (UTF-8, Windows-1251, KOI8-R, etc.)
- **PDF** - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏–∑ PDF –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É—è PyPDF2)
- **FB2** - –ø–∞—Ä—Å–∏–Ω–≥ FictionBook 2.0 —Å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (–∞–≤—Ç–æ—Ä, –Ω–∞–∑–≤–∞–Ω–∏–µ, –∂–∞–Ω—Ä—ã)
- **EPUB** - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∏–∑ ZIP-–∞—Ä—Ö–∏–≤–æ–≤ EPUB

**–ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ –¥–ª—è TXT —Ñ–∞–π–ª–æ–≤
- –û—á–∏—Å—Ç–∫–∞ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –±–æ–≥–∞—Ç—ã—Ö –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏–∑ FB2/EPUB
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 50MB

#### 2. Upload API Endpoint (`backend/app/routers/projects.py`)
**POST `/api/projects/{project_id}/texts/upload`** - –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –≤ –ø—Ä–æ–µ–∫—Ç—ã

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ (JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è)
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–æ–≤ —Ñ–∞–π–ª–æ–≤
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- –í–æ–∑–≤—Ä–∞—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ

**–ê–¥–∞–ø—Ç–∞—Ü–∏—è –≥–æ—Ç–æ–≤—ã—Ö –ø–∞—Ä—Å–µ—Ä–æ–≤:**
‚úÖ –£—Å–ø–µ—à–Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã TXT –∏ FB2 –ø–∞—Ä—Å–µ—Ä—ã –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞ `../analyse-text/backend`
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ PDF —á–µ—Ä–µ–∑ PyPDF2
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ EPUB —á–µ—Ä–µ–∑ BeautifulSoup –∏ zipfile

#### 3. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
- **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è**: JWT —Ç–æ–∫–µ–Ω—ã –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- **–ò–∑–æ–ª—è—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ñ–∞–π–ª—ã —Ç–æ–ª—å–∫–æ –≤ —Å–≤–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã  
- **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤**: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤, —Ä–∞–∑–º–µ—Ä–æ–≤, —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: HTTP 400 –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏, HTTP 404 –¥–ª—è –¥–æ—Å—Ç—É–ø–∞, HTTP 500 –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö

#### 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
- **Database integration**: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü—É `texts` —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ –≤ `file_metadata`
- **CRUD compatibility**: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö CRUD –æ–ø–µ—Ä–∞—Ü–∏–π
- **Schema compatibility**: —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å `TextCreate` —Å—Ö–µ–º–æ–π
- **Authentication flow**: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

#### ‚úÖ Unit —Ç–µ—Å—Ç—ã (100% –ø—Ä–æ—à–ª–∏)
**7 —Ç–µ—Å—Ç–æ–≤ FileProcessor** (`TestFileProcessor`):
- `test_file_processor_init` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞
- `test_get_file_format` - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ —Ñ–∞–π–ª–∞
- `test_get_file_format_invalid` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- `test_clean_text` - –æ—á–∏—Å—Ç–∫–∞ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
- `test_process_txt_file` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ TXT —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –∫–æ–¥–∏—Ä–æ–≤–∫–∏
- `test_process_fb2_file` - –ø–∞—Ä—Å–∏–Ω–≥ FB2 —Å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
- `test_detect_encoding` - –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏

–í—Å–µ unit —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤.

#### ‚ö†Ô∏è API —Ç–µ—Å—Ç—ã (—á–∞—Å—Ç–∏—á–Ω–æ - –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω—ã –∫–∞–∫ –ø—Ä–æ—Å–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
**8 –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤** (`TestFileUploadAPI`):
- ‚úÖ –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É—é—Ç
- ‚ùå –ü—Ä–æ–±–ª–µ–º—ã —Å —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î (no such table: projects/texts)

**–ö–∞–∫ –∏ –æ–∂–∏–¥–∞–ª–æ—Å—å**, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ç–µ –∂–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î, —á—Ç–æ –∏ –≤ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∑–∞–¥–∞—á–∞—Ö, –Ω–æ –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å **—Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**.

### –ê–¥–∞–ø—Ç–∞—Ü–∏—è –≥–æ—Ç–æ–≤–æ–≥–æ –∫–æ–¥–∞

**–ò–∑ –ø—Ä–æ–µ–∫—Ç–∞ `../analyse-text/backend`** —É—Å–ø–µ—à–Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã:

1. **TXT Parser** - —Å –ø–æ–ª–Ω—ã–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –∫–æ–¥–∏—Ä–æ–≤–∫–∏ –∏ –æ—á–∏—Å—Ç–∫–æ–π —Ç–µ–∫—Å—Ç–∞
2. **FB2 Parser** - —Å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (–∞–≤—Ç–æ—Ä, –Ω–∞–∑–≤–∞–Ω–∏–µ, –∂–∞–Ω—Ä—ã)
3. **Upload endpoint structure** - –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ –Ω–∞—à—É –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
4. **Error handling patterns** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã:**
- **PDF parser** - —á–µ—Ä–µ–∑ PyPDF2 —Å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
- **EPUB parser** - —á–µ—Ä–µ–∑ BeautifulSoup –∏ zipfile
- **JWT integration** - –∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –Ω–∞—à—É —Å–∏—Å—Ç–µ–º—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- **Database compatibility** - —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –Ω–∞—à–µ–π —Å—Ö–µ–º–æ–π –ë–î

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
```bash
# Unit —Ç–µ—Å—Ç—ã (–≤—Å–µ –ø—Ä–æ—Ö–æ–¥—è—Ç)
python3 -m pytest tests/test_file_upload.py::TestFileProcessor -v

# API —Ç–µ—Å—Ç—ã (—á–∞—Å—Ç–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω—ã)
python3 -m pytest tests/test_file_upload.py::TestFileUploadAPI -v
```

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
–î–æ–±–∞–≤–ª–µ–Ω—ã –≤ `requirements.txt`:
```
beautifulsoup4==4.12.2  # For EPUB and FB2 parsing
```

### –ß—Ç–æ –¥–∞–ª—å—à–µ
‚úÖ **–ó–∞–¥–∞—á–∞ 2.3: File Upload API** - –≤—ã–ø–æ–ª–Ω–µ–Ω–∞  
üîÑ –°–ª–µ–¥—É—é—â–∞—è –∑–∞–¥–∞—á–∞: **3.1 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≥–æ—Ç–æ–≤—ã—Ö –ø–∞—Ä—Å–µ—Ä–æ–≤** (TXT/FB2 —É–∂–µ –≥–æ—Ç–æ–≤—ã)

---

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è**: $(date)  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É (core —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)  
**–ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏**: 100% unit —Ç–µ—Å—Ç–æ–≤, –æ—Å–Ω–æ–≤–Ω–∞—è API —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç  
**–ê–¥–∞–ø—Ç–∞—Ü–∏—è**: –£—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –≥–æ—Ç–æ–≤—ã–µ –ø–∞—Ä—Å–µ—Ä—ã –∏–∑ —Å–æ—Å–µ–¥–Ω–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
