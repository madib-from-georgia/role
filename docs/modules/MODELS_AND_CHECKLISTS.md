# Взаимоотношения моделей DB и структуры данных для страницы

## JSON с данными

```typescript
interface Portrait {
    // id портрета: `<id портрета>`
    id: string;          
    // Название портрета: `Физический портрет`
    title: string;     
    // массив секций портрета 
    sections: Section[]; 
}

interface Section {
    // id секции: `<id секции>`
    id: string;      
    // Название секции портрета: `Внешность и физические данные`
    title: string; 
    // массив подсекций портрета 
    subsections: Subsection[]; 
}


interface Subsection {
    // id подсекции: `<id подсекции>`
    id: string;                
    // Название подсекции внутри секции: `Телосложение и антропометрия`
    title: string; 
    questionGroups: QuestionGroup[]; 
}

interface QuestionGroup {
    // id группы: `<id группы>`
    id: string;      
    // Название группы вопросов в подсекции: `Рост и пропорции тела`
    title: string; 
    questions: Question[]; 
}

interface Question {
    // id вопроса: `<id вопроса>`
    id: string;      
    // Название вопроса: `Какой у меня рост?`
    title: string; 
    answers: Answer[]; 
}

interface Answer {
    // id ответа: `<id ответа>`
    id: string;      
    // Ответ в зависимости от пола персонажа. 
    // Отображается в UI
    value: AnswerValue; 
    // Ответ в зависимости от пола персонажа. 
    // Отображается в экспортированном документе
    exportedValue: AnswerValue; 
    // Рекомендация актеру, как этот ответ влияет на технику актерской игры
    hint: string; 
}

interface AnswerValue {
    // Ответ для мужчины. Например, "Высокий"
    male: string;      
    // Ответ для женщины. Например, "Высокая" 
    female: string; 
}

const checklist: Portrait = {
    "id": "physical-portrait",
    "title": "Физический портрет",
    "sections": [
        {
            "id": "appearance",
            "title": "Внешность и физические данные",
            "subsections": [
                {
                    "id": "physique",
                    "title": "Телосложение и антропометрия",
                    "questionGroups": [
                        {
                            "id": "height-proportions",
                            "title": "Рост и пропорции тела",
                            "questions": [
                                {
                                    "id": "height",
                                    "title": "Какой у меня рост?",
                                    "answers": [
                                        {
                                            "id": "short",
                                            "value": {
                                                "male": "низкий",
                                                "female": "низкий"
                                            },
                                            "exportedValue": {
                                                 "male": "Я невысокого роста",
                                                 "female": "Я невысокого роста"
                                             },
                                            "hint": "Невысокий человек может компенсировать или комплексовать"
                                        },
                                        {
                                            "id": "average",
                                            "value": {
                                                "male": "средний",
                                                "female": "средний"
                                            },
                                            "exportedValue": {
                                                 "male": "Я среднего роста",
                                                 "female": "Я среднего роста"
                                             },
                                            "hint": "Человек среднего роста чувствует себя комфортно среди себе подобных"
                                        },
                                        {
                                            "id": "tall",
                                            "value": {
                                                "male": "высокий",
                                                "female": "высокий"
                                            },
                                            "exportedValue": {
                                                 "male": "Я высокий",
                                                 "female": "Я высокая"
                                             },
                                             "hint": "Рост влияет на самооценку и поведение — высокие часто держатся увереннее"
                                        },
                                        {
                                            "id": "custom",
                                            "value": {
                                                "male": "свой вариант",
                                                "female": "свой вариант"
                                            },
                                            "exportedValue": {
                                                 "male": "",
                                                 "female": ""
                                             },
                                            "hint": ""
                                        }
                                    ],
                                    "answerType": "single",
                                    "source": "text"
                                }
                            ]
                        }
                    ],
                    "examples": [
                        {
                            "text": "\"Пьер был неуклюж, толст, выше обыкновенного роста\"",
                            "hint": "Как найти особую походку для такого персонажа? Как он занимает пространство?"
                        },
                        {
                            "text": "\"Тонкая, как тростинка, с лебединой шеей\"",
                            "hint": "Как передать изящество движений, легкость, воздушность образа?"
                        }
                    ],
                    "hint": "Телосложение определяет базовую энергетику персонажа, влияет на ритм движений, способы взаимодействия с предметами, особенности дыхания и даже тембр голоса."
                }
            ]
        }
    ]
};
```   
  
## Таблицы BD

```typescript
// Таблица портретов
type BdPortrait = Omit<Portrait, 'sections'> & { 
    // id портрета: `<id портрета>`
    id: string;          
    // Массив id секций портрета, где id соответствует типу BdSection.id 
    section_ids: string[];
    // Сущность считается удалённой
    deleted?: boolean;
};

// Таблица секций
type BdSection = Omit<Section, 'id' | 'subsections'> & {
    // id секции: `<id портрета>_<id секции>`
    id: string;      
    // массив id подсекций портрета, где id соответствует типу BdSubsection.id 
    subsection_ids: string[]; 
    // Сущность считается удалённой
    deleted?: boolean;
}

// Таблица подсекций
type BdSubsection = Omit<Subsection, 'id' | 'questionGroups'> & {
    // id подсекции: `<id портрета>_<id секции>_<id подсекции>`
    id: string;                
    // массив id групп вопросов, где id соответствует типу BdQuestionGroup.id 
    question_group_ids: string[]; 
    // Сущность считается удалённой
    deleted?: boolean;
}

// Таблица групп вопросов
type BdQuestionGroup = Omit<QuestionGroup, 'id' | 'questions'> & {
    // id группы: `<id портрета>_<id секции>_<id подсекции>_<id группы>`
    id: string;      
    // массив id вопросов, где id соответствует типу BdQuestion.id 
    question_ids: string[]; 
    // Сущность считается удалённой
    deleted?: boolean;
}

// Таблица вопросов
type BdQuestion = Omit<Question, 'id' | 'answers'> & {
    // id вопроса: `<id портрета>_<id секции>_<id подсекции>_<id группы>_<id вопроса>`
    id: string;      
    // массив id ответов, где id соответствует типу BdAnswer.id 
    answer_ids: string[]; 
    // Сущность считается удалённой
    deleted?: boolean;
}

// Таблица ответов
type BdAnswer =  Omit<Answer, 'id'> &  {
    // id ответа: `<id портрета>_<id секции>_<id подсекции>_<id группы>_<id вопроса>_<id ответа>`
    id: string;      
}
```   
   
## Алгоритм импорта

- Источник истины - JSON одного портрета, типа docs/modules/01-physical-portrait/ACTOR_PHYSICAL_CHECKLIST.json

- Этот JSON должен иметь жесткую иерархию:
  - n секций -> m подсекций -> x групп -> y вопросов -> z ответов
  - типы данных описаны выше в разделе "JSON с данными"
  - id каждого портрета/секции/подсекции/вопроса/ответа 
    - создаются инженером руками на стадии заведения нового портрета
    - они не изменяются никогда
    - Важно помнить: 
      - id портрета — должны быть СТРОГО уникальны 
      - id остальных сущностей могут повторяться. Это некритично, потому что id этой сущности в базе данных будет иметь префикс в виде id портрета

- JSON данные импортируются в таблицы базы данных:
  - при старте приложения 
  - при вызове консольной команды

- Поля таблиц BD соответствуют типам данных, описанным выше в разделе "Таблицы BD"  
    - id каждого портрета/секции/подсекции/вопроса/ответа:
      - формируются программно на этапе импорта JSON-а с данными
      - id портрета копируется как есть, без изменений
      - id всех вложенных сущностей формируется методом конкатенации id родительской сущности и текущей сущности
         
- Создание/редактирование/удаление записей в BD
  - все записи создаются во время первого импорта данных
  - последующие импорты могут либо добавлять новые записи в таблицы, либо редактировать существующие.
  - любая импортированная запись остается в базе, никогда не удаляется
  - если нужно запись удалить — помечаем её флагом `deleted`. И тогда API не будет извлекать ее из таблицы
