# Decision Log

## Журнал архитектурных решений

### [2025-08-15 20:14:39] - Интеграция детальной документации в Memory Bank
**Решение**: Интеграция существующей детальной документации в основные файлы Memory Bank
**Обоснование**: Необходимость централизованного доступа к контексту проекта для ИИ-ассистентов
**Альтернативы**: Создание новой документации с нуля
**Последствия**: Улучшенная преемственность работы, полный контекст проекта в Memory Bank

### [2025-08-15 20:05:20] - Создание стандартной структуры Memory Bank
**Решение**: Создание 5 основных файлов Memory Bank (productContext, activeContext, systemPatterns, decisionLog, progress)
**Обоснование**: Стандартизация структуры для поддержания контекста между сессиями
**Альтернативы**: Использование только существующих файлов документации
**Последствия**: Структурированное хранение знаний, улучшенная навигация по проекту

## Исторические архитектурные решения

### Фундаментальные решения по архитектуре

#### [2024] - Выбор технологического стека: FastAPI + React + SQLite
**Решение**: Python (FastAPI) для backend, React с TypeScript для frontend, SQLite для локальной базы данных
**Обоснование**: 
- **FastAPI**: Высокая производительность, автоматическая документация API, нативная поддержка async/await
- **React + TypeScript**: Типобезопасность, современный UX, большая экосистема компонентов
- **SQLite**: Простота развертывания, отсутствие зависимостей, достаточная производительность для локального использования
**Альтернативы**: Django + Vue.js + PostgreSQL, Flask + Angular + MySQL
**Последствия**: Быстрая разработка, простое развертывание, но ограничения масштабируемости

#### [2024] - Модульная архитектура: 20 независимых модулей анализа
**Решение**: Разделение анализа персонажей на 20 специализированных модулей
**Обоснование**: 
- Разные аспекты анализа требуют специализированного подхода
- Возможность независимого развития и тестирования модулей
- Гибкость для пользователей - выборочное использование модулей
**Альтернативы**: Единый универсальный чек-лист, группировка в 5-7 больших модулей
**Последствия**: Сложность архитектуры, но максимальная гибкость и научная обоснованность

#### [2024] - Интеграция методологии Станиславского с современной психологией
**Решение**: Базовые модули (1-13) основаны на Станиславском, психологические модули (14-20) на современных теориях
**Обоснование**: 
- Станиславский - признанная основа актерского мастерства
- Современная психология дает научную глубину анализа
- Комбинация обеспечивает практическую и теоретическую ценность
**Альтернативы**: Только Станиславский, только современная психология, другие театральные методики
**Последствия**: Уникальность продукта, но сложность интеграции разных подходов

### Технические архитектурные решения

#### [2024] - Система версионирования чек-листов и ответов
**Решение**: Версионирование всех чек-листов и привязка ответов пользователей к конкретным версиям
**Обоснование**: 
- Необходимость эволюции модулей без потери пользовательских данных
- Возможность отката к предыдущим версиям
- Научная точность - ответы привязаны к конкретным формулировкам вопросов
**Альтернативы**: Перезапись данных без версионирования, миграция данных при обновлениях
**Последствия**: Усложнение схемы БД, но гарантия целостности данных

#### [2024] - NLP-интеграция для автоматического извлечения данных
**Решение**: Использование spaCy для автоматического анализа текстов и извлечения характеристик персонажей
**Обоснование**: 
- Ускорение процесса анализа для пользователей
- Повышение точности через автоматическое нахождение цитат
- Конкурентное преимущество перед ручными методами
**Альтернативы**: Только ручное заполнение чек-листов, интеграция с внешними NLP API
**Последствия**: Значительное повышение ценности продукта, но сложность разработки и поддержки

#### [2024] - Локальная архитектура vs облачная
**Решение**: Локальное развертывание с SQLite базой данных
**Обоснование**: 
- Простота установки и использования
- Отсутствие зависимости от интернета
- Полный контроль пользователя над данными
- Отсутствие затрат на инфраструктуру
**Альтернативы**: SaaS модель с облачной базой данных
**Последствия**: Ограничения в коллаборации и синхронизации, но максимальная простота использования

### Решения по безопасности и аутентификации

#### [2024] - JWT токены для аутентификации
**Решение**: Использование JWT токенов с коротким временем жизни (15 мин access, 7 дней refresh)
**Обоснование**: 
- Stateless подход обеспечивает масштабируемость
- Безопасность через короткое время жизни access токенов
- Удобство через автоматическое обновление
**Альтернативы**: Session-based аутентификация, OAuth интеграция
**Последствия**: Хорошая безопасность и производительность, но сложность управления токенами

#### [2024] - Row Level Security для изоляции данных
**Решение**: Каждый пользователь видит только свои проекты и персонажей
**Обоснование**: 
- Защита конфиденциальности пользовательских данных
- Соответствие принципам минимальных привилегий
- Простота реализации через фильтрацию по user_id
**Альтернативы**: Роли и разрешения, ACL системы
**Последствия**: Простая и надежная изоляция данных

### Решения по пользовательскому интерфейсу

#### [2024] - Адаптивный веб-интерфейс вместо нативных приложений
**Решение**: Единый React интерфейс с адаптивной версткой для всех устройств
**Обоснование**: 
- Единая кодовая база снижает затраты на разработку
- Быстрое развертывание обновлений
- Кроссплатформенность без дополнительных усилий
**Альтернативы**: Нативные iOS/Android приложения, Electron для десктопа
**Последствия**: Экономия ресурсов разработки, но ограничения в нативном UX

#### [2024] - Custom CSS вместо UI библиотек
**Решение**: Собственные стили без использования Material-UI, Ant Design и подобных
**Обоснование**: 
- Полный контроль над внешним видом
- Минимальный размер bundle
- Уникальный дизайн, соответствующий театральной тематике
**Альтернативы**: Material-UI, Ant Design, Chakra UI
**Последствия**: Больше времени на разработку UI, но уникальный и оптимизированный интерфейс

### Решения по обработке данных

#### [2024] - Поддержка множественных форматов файлов
**Решение**: Парсеры для TXT, PDF, FB2, EPUB форматов
**Обоснование**: 
- Театральные тексты существуют в разных форматах
- Удобство для пользователей - не нужно конвертировать файлы
- Конкурентное преимущество
**Альтернативы**: Поддержка только TXT, требование конвертации от пользователей
**Последствия**: Сложность разработки парсеров, но значительное удобство для пользователей

#### [2024] - Система оценки достоверности ответов
**Решение**: 4-уровневая система оценки: подтверждено текстом, логически выведено, культурно типично, творчески дополнено
**Обоснование**: 
- Научная честность - разделение фактов и интерпретаций
- Помощь актерам в понимании надежности характеристик
- Основа для будущих алгоритмов машинного обучения
**Альтернативы**: Бинарная система (есть/нет подтверждение), отсутствие градации
**Последствия**: Усложнение интерфейса, но повышение научной ценности

### Решения по экспорту и интеграции

#### [2024] - Экспорт в PDF и DOCX форматы
**Решение**: Генерация отчетов в популярных форматах документов
**Обоснование**: 
- Потребность актеров в печатных материалах для репетиций
- Возможность архивирования результатов анализа
- Интеграция с существующими театральными процессами
**Альтернативы**: Только веб-интерфейс, экспорт в HTML
**Последствия**: Дополнительная сложность генерации документов, но значительная практическая ценность

#### [2024] - JSON кэширование результатов NLP
**Решение**: Сохранение результатов NLP обработки в JSON файлах для быстрого доступа
**Обоснование**: 
- NLP обработка ресурсоемкая - избежание повторных вычислений
- Быстрый доступ к результатам анализа
- Возможность офлайн работы после первичной обработки
**Альтернативы**: Повторная обработка при каждом запросе, кэширование в базе данных
**Последствия**: Дополнительное использование дискового пространства, но значительное ускорение работы

## Отложенные решения

### Архитектурные решения в процессе принятия

#### Переход на PostgreSQL
**Статус**: Планируется для версии 2.0
**Варианты**: PostgreSQL, MySQL, остаться на SQLite
**Критерии**: Производительность, функциональность, сложность миграции
**Блокеры**: Необходимость сохранения простоты локального развертывания

#### Выбор стратегии кэширования
**Статус**: Исследуется
**Варианты**: Redis, Memcached, расширение текущего JSON кэша
**Критерии**: Производительность, потребление памяти, сложность настройки
**Блокеры**: Добавление внешних зависимостей противоречит принципу простоты

#### Интеграция с AI-сервисами
**Статус**: Экспериментальная фаза
**Варианты**: Yandex GPT, OpenAI GPT, локальные модели
**Критерии**: Качество анализа, стоимость, приватность данных
**Блокеры**: Зависимость от внешних сервисов, стоимость для пользователей

#### Архитектура мониторинга
**Статус**: Планируется для production
**Варианты**: ELK Stack (Elasticsearch, Logstash, Kibana), Prometheus + Grafana
**Критерии**: Простота настройки, информативность метрик, потребление ресурсов
**Блокеры**: Сложность настройки для локального развертывания

#### Стратегия мобильных приложений
**Статус**: Долгосрочное планирование
**Варианты**: PWA, React Native, нативные приложения
**Критерии**: Производительность, UX, затраты на разработку
**Блокеры**: Ограниченные ресурсы команды разработки

### Технические решения требующие исследования

#### Оптимизация NLP для больших файлов
**Проблема**: Обработка файлов >50MB занимает много времени
**Варианты**: Потоковая обработка, разбиение на чанки, параллельная обработка
**Исследование**: Тестирование производительности различных подходов

#### Улучшение точности атрибуции речи
**Проблема**: Сложные тексты с множественными персонажами обрабатываются неточно
**Варианты**: Машинное обучение, правила на основе контекста, гибридный подход
**Исследование**: Анализ ошибок на корпусе театральных текстов

#### Система коллаборации
**Проблема**: Актеры и режиссеры хотят работать совместно над анализом
**Варианты**: Real-time collaboration, асинхронное редактирование, система комментариев
**Исследование**: Анализ пользовательских потребностей

## Принципы принятия решений

### Критерии оценки архитектурных решений
1. **Простота использования** - приоритет удобства для конечных пользователей
2. **Научная обоснованность** - соответствие театральным и психологическим теориям
3. **Техническая надежность** - стабильность и производительность системы
4. **Масштабируемость** - возможность роста без кардинальных изменений
5. **Открытость** - предпочтение open-source решений

### Процесс принятия решений
1. **Анализ проблемы** - четкое определение решаемой задачи
2. **Исследование альтернатив** - рассмотрение минимум 3 вариантов
3. **Прототипирование** - создание MVP для критичных решений
4. **Консультации** - обсуждение с экспертами предметной области
5. **Документирование** - фиксация решения и обоснования

---

*[2025-08-15 20:14:39] - Интеграция исторических архитектурных решений*

### [2025-08-16 17:39:48] - Реализация ручного добавления персонажей
**Решение**: Добавление функциональности ручного создания персонажей через UI на странице ProjectDetail.tsx
**Обоснование**: 
- Пользователи должны иметь возможность добавлять персонажей вручную, а не только через автоматический импорт
- Это расширяет функциональность системы и делает ее более гибкой
- Персонажи привязываются к текстам, что соответствует существующей архитектуре
**Альтернативы**: Создание отдельной страницы для управления персонажами
**Последствия**: 
- Улучшенный пользовательский опыт
- Возможность создания персонажей без загрузки текстов
- Интеграция с существующей системой чек-листов

**Технические решения**:
- POST эндпоинт `/api/texts/{text_id}/characters` в роутере texts.py
- Использование существующих схем `CharacterCreate` и CRUD операций
- UI форма с полями для имени и пола персонажа
- Валидация на уникальность имени персонажа в рамках текста
- Автоматическое обновление кэша персонажей после создания

### [2025-08-17 16:13:45] - Решение проблемы экспорта файлов на мобильных устройствах
**Решение**: Реализация улучшенной системы скачивания файлов с поддержкой мобильных устройств
**Проблема**: На мобильных устройствах файлы открывались в новой вкладке с URL вида `blog://https://...` вместо скачивания
**Обоснование**: 
- Мобильные браузеры (особенно iOS Safari) имеют ограничения на программное скачивание файлов
- Стандартный подход с созданием временной ссылки и программным кликом не работает надежно
- Необходимы альтернативные методы для разных типов мобильных браузеров
**Альтернативы**: Использование только стандартного подхода, отказ от поддержки мобильных устройств
**Последствия**: Значительное улучшение пользовательского опыта на мобильных устройствах

**Технические решения**:
- Добавлена детекция мобильных устройств и iOS Safari
- Реализована поддержка Web Share API для современных мобильных браузеров
- Создано модальное окно с инструкциями для iOS Safari
- Добавлена правильная обработка MIME-типов файлов
- Улучшены сообщения для пользователей с учетом типа устройства
- Реализована асинхронная обработка скачивания файлов

**Файлы изменены**:
- `frontend/src/utils/downloadFile.ts` - основная логика скачивания
- `frontend/src/components/checklists/ExportDialog.tsx` - обновлен UI компонент